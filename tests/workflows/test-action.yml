name: Test Action Locally

on:
  workflow_dispatch:
  # For local testing with act: https://github.com/nektos/act
  # Run with: act -j test-action

env:
  TEST_PARAM_1: "/test-action/param1"
  TEST_PARAM_2: "/test-action/param2"
  TEST_VALUE_1: "value1"
  TEST_VALUE_2: "value2"

jobs:
  test-action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup LocalStack
        run: |
          docker compose up -d localstack
          until curl -s http://localhost:4566/health?services=ssm | grep -q '"ssm": "running"'; do
            sleep 1
          done
          aws configure set aws_access_key_id test
          aws configure set aws_secret_access_key test
          aws configure set region us-east-1
          aws configure set output json
          aws configure set endpoint_url http://localhost:4566

      # Create test parameters in LocalStack
      - name: Create test parameters
        run: |
          aws --endpoint-url=http://localhost:4566 ssm put-parameter --name "$TEST_PARAM_1" --value "$TEST_VALUE_1" --type String --overwrite
          aws --endpoint-url=http://localhost:4566 ssm put-parameter --name "$TEST_PARAM_2" --value "$TEST_VALUE_2" --type String --overwrite
          # Verify parameters were created
          aws --endpoint-url=http://localhost:4566 ssm get-parameter --name "$TEST_PARAM_1" --query "Parameter.Value"
          aws --endpoint-url=http://localhost:4566 ssm get-parameter --name "$TEST_PARAM_2" --query "Parameter.Value"

      # Install Chamber locally for testing
      - name: Install Chamber
        run: |
          CHAMBER_VERSION="2.10.12" # using a specific stable version
          echo "Installing Chamber version $CHAMBER_VERSION..."
          mkdir -p /tmp/chamber
          curl -sSL "https://github.com/segmentio/chamber/releases/download/v${CHAMBER_VERSION}/chamber-v${CHAMBER_VERSION}-linux-amd64" -o /tmp/chamber/chamber
          chmod +x /tmp/chamber/chamber
          sudo mv /tmp/chamber/chamber /usr/local/bin/chamber
          chamber version

      # Run all three test configurations
      - name: Run standard action tests
        uses: ./.github/workflows/test-action-configs.yml

      - name: Clean up
        if: always()
        run: docker compose down